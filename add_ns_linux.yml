---
- name: Set agency dns name servers in /etc/resolv.conf
  hosts: all
  gather_facts: no
   
  tasks:

  - name: set agency var
    set_fact: 
      agency: "{{ agency }}"

# Only need this var because one agency had the same name with two different domains being passed as json payload. 
  - name: set domain var
    set_fact: 
      domain: "{{ domain }}"
  
  - name: remove immutable setting of file to allow file changes
    shell: chattr -i /etc/resolv.conf

# 5/23/22 
# Notes: 
# For ADC and SDC locations is set for each agency below. 
# Setting when agency == to string for an agency to be identified as match. 

  - name: AGENCY1 - Add content to resolv.conf 
    lineinfile:
      path: /etc/resolv.conf
      line: "{{ item }}"
      state: present
    with_items:
      - '# Generated by NetworkManager'
      - search domain1.edu domain1.local
      - nameserver 12.34.56.78
      - nameserver 87.65.43.21
    when: 
      - agency == 'AGENCY1'

  - name: AGENCY2 - Add content to resolv.conf 
    lineinfile:
      path: /etc/resolv.conf
      line: "{{ item }}"
      state: present
    with_items:
      - '# Generated by NetworkManager'
      - search agency.us 
      - nameserver 10.101.10.103
      - nameserver 10.101.10.104
    when: (agency == 'AGENCY2') and (domain == 'agency.us ')
  
  - name: AGENCY2 - Add content to resolv.conf 
    lineinfile:
      path: /etc/resolv.conf
      line: "{{ item }}"
      state: present
    when: (agency == 'AGENCY2') and (domain == '2ndagency.us')
    with_items:
      - '# Generated by NetworkManager'
      - search 2ndagency.us 
      - nameserver 123.45.27.11
      - nameserver 123.45.27.12

  - name: readd immutable setting of file to NOT allow file changes
    shell: chattr +i /etc/resolv.conf

  - name: show file is immutable again
    shell: lsattr /etc/resolv.conf
